services:
  lan-controller:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lan-controller
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - "/dev/net/tun:/dev/net/tun"
    sysctls:
      - net.ipv4.ip_forward=1
    environment:
      PORT: 8787
      ZT_API_TOKEN: ${ZT_API_TOKEN}
      ZT_DEFAULT_NETWORK_ID: ${ZT_DEFAULT_NETWORK_ID}
      LAN_CONTROLLER_API_KEY: ${LAN_CONTROLLER_API_KEY}
      # VPN (WireGuard) controller
      VPN_ENABLE: ${VPN_ENABLE}
      WG_INTERFACE: ${WG_INTERFACE}
      WG_LISTEN_PORT: ${WG_LISTEN_PORT}
      WG_ENDPOINT_HOST: ${WG_ENDPOINT_HOST}
      WG_ENDPOINT_PORT: ${WG_ENDPOINT_PORT}
      WG_SERVER_ADDRESS: ${WG_SERVER_ADDRESS}
      WG_SUBNET_CIDR: ${WG_SUBNET_CIDR}
      WG_DNS: ${WG_DNS}
      VPN_STATE_FILE: /data/vpn-state.json
      VPN_ROOM_TTL_DAYS: ${VPN_ROOM_TTL_DAYS}
      VPN_PEER_TTL_DAYS: ${VPN_PEER_TTL_DAYS}
    ports:
      # WireGuard UDP endpoint (must be reachable by clients)
      - "51820:51820/udp"
    volumes:
      - ./data:/data
    networks:
      - lan

  caddy:
    image: caddy:2-alpine
    container_name: lan-controller-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - lan

networks:
  lan:
    name: lan-controller-net

volumes:
  caddy_data:
  caddy_config:

